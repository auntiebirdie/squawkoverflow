DELIMITER $$

DROP TRIGGER IF EXISTS squawk_counters_update$$

CREATE TRIGGER `squawk_counters_insert` AFTER INSERT ON `squawkdata.birdypets`$$
FOR EACH ROW BEGIN
  DECLARE `species` VARCHAR(50);
  DECLARE `family` VARCHAR(50);
  SELECT species INTO species FROM variants WHERE id = NEW.variant;
  SELECT family INTO family FROM species WHERE code = @species;
  INSERT INTO squawkdata.counters VALUES (NEW.member, "variant", NEW.variant, 1) ON DUPLICATE KEY UPDATE `count` = `count` + 1;
  INSERT INTO squawkdata.counters VALUES (NEW.member, "species", species, 1) ON DUPLICATE KEY UPDATE `count` = `count` + 1;
  INSERT INTO squawkdata.counters VALUES (NEW.member, "family", family, 1) ON DUPLICATE KEY UPDATE `count` = `count` + 1;
END$$

DELIMITER ;
