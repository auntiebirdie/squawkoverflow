<%- include('../header.ejs') %>

  <%- include('../partials/page-title.ejs', { title : bird.commonName, subtitle : bird.scientificName }) %>

  <% var licenses = {
       "CC0" : "https://creativecommons.org/publicdomain/zero/1.0/",
       "CC-BY 1.0" : "https://creativecommons.org/licenses/by/1.0/",
       "CC-BY 2.0" : "https://creativecommons.org/licenses/by/2.0/",
       "CC-BY 3.0" : "https://creativecommons.org/licenses/by/3.0/",
       "CC-BY 4.0" : "https://creativecommons.org/licenses/by/4.0/",
       "CC-BY-SA 1.0" : "https://creativecommons.org/licenses/by-sa/1.0/",
       "CC-BY-SA 2.0" : "https://creativecommons.org/licenses/by-sa/2.0/",
       "CC-BY-SA 3.0" : "https://creativecommons.org/licenses/by-sa/3.0/",
       "CC-BY-SA 4.0" : "https://creativecommons.org/licenses/by-sa/4.0/",
       "Pixabay" : "https://pixabay.com/service/license/"
     }
  %>

  <div class="row">
    <div class="col-12 col-md-8 text-center mb-4 position-relative">
      <span class="h-100 d-inline-block position-relative">
       <% if (locals.loggedInUser) { %>
        <div class="birdypet-actions">
          <button class="wishlist-heart btn btn-sm" data-id="<%= bird.id %>" role="button">
            <%= bird.wishlisted ? (bird.wishlisted == 2 ? '🌟' : '❤️') : '🤍' %>
          </button>
        </div>
       <% } %>
        <img id="birdy" src="<%= variant.image %>" class="birdypet full <%= bird.discovered ? "hatched" : "unhatched" %>">
      </span>
      <br>
      <span id="attribution" class="bg-light d-inline-block mt-2 px-2 py-1 small" style="display: <%= variant.source == "n/a" ? "none" : "inline-block" %>">
       <% if (variant.source != "n/a") { %>
        &copy;

        <a id="attribution-license" class="small mt-1" href="<%= licenses[variant.license] %>" target="_blank" rel="noopener" style="display: <%= variant.license ? "inline-block" : "none" %>">
          <%= variant.license %>
        </a>

        <a id="attribution-credit" class="small" href="<%= variant.source %>" target="_blank" rel="noopener">
          <%= variant.credit %>
        </a>

        <span id="attribution-notes" class="bg-dark rounded-circle px-2 ms-2" data-bs-toggle="tooltip" data-bs-placement="top" title="<%= variant.notes %>" style="display: <%= variant.notes ? "inline-block" : "none" %>">ℹ</span>

       <% } %>
      </span>
    </div>
    <div class="col-12 col-md-4 mb-4">
      <h5 class="pt-3">
        Variants
       <% if (locals.loggedInUser && loggedInUser.contributor) { %>
        <a href="/birdypedia/bird/<%= bird.id_slug %>/variant/new" class="btn btn-sm btn-light p-1 ms-3">+ new</a>
       <% } %>
      </h5>

        <div id="birdDisplay">
          <div class="row mb-3">
         <% for (var variant of bird.variants) { %>
         <% if (!variant.special) { %>
            <div class="col-3 mb-3 text-center">
              <div class="m-0 birdypet mini <%= bird.discovered ? "hatched" : "unhatched" %> checkmark<%= Math.min(2, variant.hatched) %>" data-id="<%= variant.id %>" data-image="<%= variant.image %>" data-credit="<%= variant.credit %>" data-source="<%= variant.source %>" data-license="<%= variant.license %>" data-notes="<%= encodeURIComponent(variant.notes) %>" style="background-image: url('<%= variant.image %>');"></div>
            </div>
         <% } %>
         <% } %>
          </div>

       <% if (bird.variants.find((variant) => variant.special)) { %>
        <h6>Special Variants</h6>
         <% for (var variant of bird.variants) { %>
         <% if (variant.special) { %>
          <div class="row mb-3">
            <div class="col-3 g-0 text-end">
              <div class="bg-white border border-1 m-0 birdypet mini <%= variant.hatched ? "hatched" : "unhatched" %> checkmark<%= Math.min(2, variant.hatched) %>" data-id="<%= variant.id %>" data-image="<%= variant.image %>" data-credit="<%= variant.credit %>" data-source="<%= variant.source %>" data-license="<%= variant.license %>" data-notes="<%= encodeURIComponent(variant.notes) %>" style="background-image: url('<%= variant.image %>');"></div>
            </div>
            <div class="col-9 small">
              <% if (locals.loggedInUser && loggedInUser.contributor) { %>
                <a href="/birdypedia/bird/<%= bird.id_slug %>/variant/<%= variant.id %>" class="btn btn-sm btn-light m-2 float-end">edit</a>
              <% } %>
              <%- variant.label ? `${variant.label}` : '' %>
            </div>
          </div>
         <% } %>
         <% } %>
       <% } %>
        </div>
    </div>
  </div>

  <script type="text/javascript">
    $(document).ready(function () {
      var urlParams = new URLSearchParams(window.location.search);

      $('#birdDisplay').on('click', '.birdypet.mini', function (event) {
        var variant = event.target;
        var full = document.getElementById('birdy');
        var attribution = document.getElementById('attribution');
        var credit = document.getElementById('attribution-credit');
        var license = document.getElementById('attribution-license');
        var notes = document.getElementById('attribution-notes');

        var licenses = <%- JSON.stringify(licenses) %>;

        full.src = variant.getAttribute('data-image');

        if (variant.getAttribute('data-source').startsWith('http')) {
          attribution.style.display = "inline-block";
          credit.href = variant.getAttribute('data-source');
          credit.innerHTML = variant.getAttribute('data-credit');

          if (variant.getAttribute('data-license')) {
            license.style.display = "inline-block";
            license.href = licenses[variant.getAttribute('data-license')];
            license.innerHTML = variant.getAttribute('data-license');
          }
          else {
            license.style.display = "none";
          }

          if (variant.getAttribute('data-notes') && variant.getAttribute('data-notes') != "null") {
            notes.style.display = "inline-block";
            notes.setAttribute('title', decodeURIComponent(variant.getAttribute('data-notes')));
            tooltipList.forEach((tooltip) => tooltip.update());
          }
          else {
            notes.style.display = "none";
          }
        }
        else {
          attribution.style.display = "none";
        }

        urlParams.set('variant', variant.getAttribute('data-id'));

        window.history.replaceState(null, '', window.location.pathname + '?' + urlParams.toString());

        if (variant.className.includes('unhatched')) {
          $(full).removeClass('hatched').addClass('unhatched');
        }
        else {
          $(full).removeClass('unhatched').addClass('hatched');
        }
      });
    });
  </script>

<%- include('../scripts/tooltips.ejs') %>
<%- include('../footer.ejs') %>
