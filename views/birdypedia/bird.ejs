<%- include('../header.ejs') %>

  <%- include('../partials/page-title.ejs', { title : bird.commonName, subtitle : bird.scientificName }) %>

  <% var licenses = {
       "CC0" : "https://creativecommons.org/publicdomain/zero/1.0/",
       "CC-BY 1.0" : "https://creativecommons.org/licenses/by/1.0/",
       "CC-BY 2.0" : "https://creativecommons.org/licenses/by/2.0/",
       "CC-BY 3.0" : "https://creativecommons.org/licenses/by/3.0/",
       "CC-BY 4.0" : "https://creativecommons.org/licenses/by/4.0/",
       "CC-BY-SA 1.0" : "https://creativecommons.org/licenses/by-sa/1.0/",
       "CC-BY-SA 2.0" : "https://creativecommons.org/licenses/by-sa/2.0/",
       "CC-BY-SA 3.0" : "https://creativecommons.org/licenses/by-sa/3.0/",
       "CC-BY-SA 4.0" : "https://creativecommons.org/licenses/by-sa/4.0/"
     }
  %>

  <div class="text-center mb-4 position-relative">
    <span class="h-100 d-inline-block position-relative">
     <% if (locals.loggedInUser) { %>
      <div class="birdypet-actions">
        <button class="wishlist-heart btn btn-sm" data-id="<%= bird.id %>" role="button">
          <%= bird.wishlisted ? (bird.wishlisted == 2 ? '🌟' : '❤️') : '🤍' %>
        </button>
      </div>
     <% } %>
      <img id="birdy" src="<%= variant.image %>" class="birdypet full <%= bird.discovered ? "hatched" : "unhatched" %>">
    </span>
    <br>
    <span id="attribution" class="bg-light d-inline-block mt-2 px-2 py-1 small" style="display: <%= variant.source == "n/a" ? "none" : "inline-block" %>">
     <% if (variant.source != "n/a") { %>
      &copy;

      <a id="attribution-license" class="small mt-1" href="<%= licenses[variant.license] %>" target="_blank" rel="noopener" style="display: <%= variant.license ? "inline-block" : "none" %>">
        <%= variant.license %>
      </a>

      <a id="attribution-credit" class="small" href="<%= variant.source %>" target="_blank" rel="noopener">
        <%= variant.credit %>
      </a>

      <span id="attribution-notes" class="bg-dark rounded-circle px-2 ms-2" data-bs-toggle="tooltip" data-bs-placement="top" title="<%= variant.notes %>" style="display: <%= variant.notes ? "inline-block" : "none" %>">ℹ</span>

     <% } %>
    </span>
  </div>

  <h4 class="mb-4">Who has one?</h4>
  <% let membersOwned = bird.members ? bird.members.filter((member) => member.owned > 0) : []; %>
  <% if (membersOwned.length > 0) { %>
    <% for (let i = 0, len = membersOwned.length; i < len; i++) { %>
      <% let member = membersOwned[i] %>
      <% if (i % 4 === 0) { %>
        <% if (i > 0) { %>
          </div>
        <% } %>
      <div class="row">
      <% } %>
        <div class="col-md-3 mb-3">
          <div class="row">
          <div class="col-3 text-center">
            <a href="/aviary/<%= member.id %>?search=%22<%= bird.commonName %>%22">
              <img class="rounded" src="<%= member.avatar %>" data-id="<%= member.id %>" onerror="missingMemberAvatar(this)">
            </a>
          </div>
          <div class="col-8 mb-3">
            <h5 class="pt-2">
              <a href="/aviary/<%= member.id %>?search=%22<%= bird.commonName %>%22">
                <%= member.username %>
              </a>
            </h5>
          </div>
        </div>
      </div>
    <% }; %>
  <% } else { %>
    <p><em>This bird doesn't appear to be in any aviaries... yet!</em></p>
  <% } %>

  <h4 class="mt-4 mb-4">Who wants one?</h4>
  <% let membersWishlisted = bird.members ? bird.members.filter((member) => member.wishlisted > 0) : []; %>
  <% if (membersWishlisted.length > 0) { %>
    <% for (let i = 0, len = membersWishlisted.length; i < len; i++) { %>
      <% let member = membersWishlisted[i] %>
      <% if (i % 4 === 0) { %>
        <% if (i > 0) { %>
          </div>
        <% } %>
      <div class="row">
      <% } %>
        <div class="col-md-3 mb-3">
          <div class="row">
          <div class="col-3 text-center">
            <a href="/aviary/<%= member.id %>?search=%22<%= bird.commonName %>%22">
              <img class="rounded" src="<%= member.avatar %>" data-id="<%= member.id %>" onerror="missingMemberAvatar(this)">
            </a>
          </div>
          <div class="col-8 mb-3">
            <h5 class="pt-2">
              <a href="/aviary/<%= member.id %>?search=%22<%= bird.commonName %>%22">
                <%= member.username %>
              </a>
            </h5>
          </div>
        </div>
      </div>
    <% }; %>
  <% } else { %>
    <p><em>This bird doesn't appear to be in any wishlists... yet!</em></p>
  <% } %>

  <script type="text/javascript">
    $(document).ready(function () {
      var urlParams = new URLSearchParams(window.location.search);

      $('#birdDisplay').on('click', '.birdypet.mini', function (event) {
        var variant = event.target;
        var full = document.getElementById('birdy');
        var attribution = document.getElementById('attribution');
        var credit = document.getElementById('attribution-credit');
        var license = document.getElementById('attribution-license');
        var notes = document.getElementById('attribution-notes');

        var licenses = <%- JSON.stringify(licenses) %>;

        full.src = variant.getAttribute('data-image');

        if (variant.getAttribute('data-source').startsWith('http')) {
          attribution.style.display = "inline-block";
          credit.href = variant.getAttribute('data-source');
          credit.innerHTML = variant.getAttribute('data-credit');

          if (variant.getAttribute('data-license')) {
            license.style.display = "inline-block";
            license.href = licenses[variant.getAttribute('data-license')];
            license.innerHTML = variant.getAttribute('data-license');
          }
          else {
            license.style.display = "none";
          }

          if (variant.getAttribute('data-notes') && variant.getAttribute('data-notes') != "null") {
            notes.style.display = "inline-block";
            notes.setAttribute('title', decodeURIComponent(variant.getAttribute('data-notes')));
            tooltipList.forEach((tooltip) => tooltip.update());
          }
          else {
            notes.style.display = "none";
          }
        }
        else {
          attribution.style.display = "none";
        }

        urlParams.set('variant', variant.getAttribute('data-id'));

        window.history.replaceState(null, '', window.location.pathname + '?' + urlParams.toString());

        if (variant.className.includes('unhatched')) {
          $(full).removeClass('hatched').addClass('unhatched');
        }
        else {
          $(full).removeClass('unhatched').addClass('hatched');
        }
      });
    });
  </script>

<%- include('../scripts/tooltips.ejs') %>
<%- include('../footer.ejs') %>
