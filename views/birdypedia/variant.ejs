<%- include('../header.ejs') %>

  <%- include('../partials/page-title.ejs', { title : bird.commonName, subtitle : variant ? 'Edit Variant' : 'Upload New Variant' }) %>

  <div id="form" class="row">
    <div class="col-12 col-md-8 mb-4">
      <h5><label for="form-url" >Image URL</label></h5>
      <input type="text" id="form-url" class="form-control mb-3 w-100" value="<%= variant?.image %>">

      <h5><label for="form-source">Source</label></h5>
      <input type="text" id="form-source" class="form-control mb-3 w-100" value="<%= variant?.source %>">

      <div class="row mb-3">
        <div class="col-6">
          <h5><label for="form-credit">Credit</label></h5>
          <input type="text" id="form-credit" class="form-control mb-3 w-100" value="<%= variant?.credit %>">
        </div>
        <div class="col-6">
          <h5><label for="form-member">Member</label></h5>
          <div id="memberSearch" class="mb-3">
            <input class="typeahead form-control" type="text">
          </div>

          <div id="memberDisplay">
           <% if (variant && variant.artist) { %>
            <h3><img src="<%= variant.artist.avatar %>" class="rounded" width="75" data-id="<%= variant.artist.id %>" onerror="missingMemberAvatar(this)"> <%= variant.artist.username %></h3>
           <% } %>
          </div>
        </div>
      </div>

      <div class="row mb-3">
        <div class="col-6">
          <h5><label for="form-label">Label</label></h5>
          <input type="text" id="form-label" class="form-control mb-3 w-100" value="<%= variant?.label %>">
        </div>
        <div class="col-6">
          <h5><label for="form-subspecies">Subspecies</label></h5>
          <input type="text" id="form-subspecies" class="form-control mb-3 w-100" value="<%= variant?.subspecies %>">
        </div>
      </div>

      <div class="form-check form-check-inline">
        <input class="form-check-input" type="checkbox" id="form-full" <%= variant ? (variant.full ? 'checked' : '') : 'checked' %>>
        <label class="form-check-label" for="form-full">
            Full image (not a headshot/closeup/detail)
        </label>
      </div>

      <div class="form-check form-check-inline">
        <input class="form-check-input" type="checkbox" id="form-special" <%= variant?.special ? 'checked' : '' %>>
        <label class="form-check-label" for="form-special" <%= loggedInUser.admin ? '' : 'disabled' %>>
            Special (not available through hatching)
        </label>
      </div>
    </div>
    <div class="col-12 col-md-4 mb-4 text-center">
      <p>Preview:</p>
      <img id="form-preview" class="birdypet" src="<%= variant ? variant.image : '/img/placeholder.jpeg' %>">
    </div>

    <div class="col-12 text-center">
      <a id="submitVariant" class="btn btn-dark"><%= variant ? 'Update' : 'Upload' %></a>
    </div>
  </div>

  <%- include('../scripts/membersearch.ejs', { include : ['self'] }) %>

  <script type="text/javascript">
    $(document).ready(function () {
      $('#form-url').on('change', function () {
        $('#form-preview').attr('src', $('#form-url').val());
      });

      $('#submitVariant').on('click', function () {
        var container = document.getElementById('form');

        if (!container.classList.contains('loadingData')) {
          container.classList.add('loadingData');

          API.call('variant', 'POST', {
              <%- variant ? `id: "${variant.id}",` : '' %>
              url: $('#form-url').val(),
              source: $('#form-source').val(),
              species: '<%= bird.id %>',
              subspecies: $('#form-subspecies').val(),
              credit: $('#form-credit').val(),
              artist: $('img', '#memberDisplay').attr('data-id'),
              full: $('#form-full').is(':checked'),
              special: $('#form-special').is(':checked'),
              label: $('#form-label').val()
            }, function (response) {
              window.location.replace('/birdypedia/bird/<%= bird.id_slug %>?variant=' + response);
            }, function (error) {
              container.classList.remove('loadingData');
            }
          );
        }
      });
    });
  </script>

<%- include('../footer.ejs') %>
