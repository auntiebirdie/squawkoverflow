<%- include('../header.ejs') %>

    <%- include('../partials/page-title.ejs', {
          title : memberpet.nickname ? memberpet.nickname : memberpet.species.commonName,
          breadcrumb: {
            text: `${member.username}'s`,
            url: `/members/${member._id}`,
            prepend: `<img class="member-avatar avatar-sm" src="${member.avatar}" data-id="${member._id}" onerror="missingMemberAvatar(this)">`
          }
    }) %>

    <div class="row">
      <div class="col-md-8 pt-3">
        <div class="text-center">
          <img id="birdy" src="<%= memberpet.image %>">
        </div>

        <% if (locals.loggedInUser && member._id == locals.loggedInUser.id) { %>
          <%- include('../partials/spacer.ejs'); %>

          <form id="manageBirdyPet" method="POST">

          <div class="row">
            <div class="col-12 col-8 mb-3">
              <h5><label>Nickname</label></h5>
              <input id="nickname" type="text" name="nickname" class="form-control" value="<%= memberpet.nickname %>" style="width: 100%">
            </div>
            <div class="col-12 col-md-4 mb-3">
            <% if (!memberpet.special && otherVersions.length > 1) { %>
              <h5><label>Variant</label></h5>
              <select name="variant" class="form-select">
                <% for (let otherVersion of otherVersions) { %>
                <option value="<%= otherVersion.id %>" <%= otherVersion.id == memberpet.birdypetId ? "selected" : "" %>>
                  <%= otherVersion.version %>
                  <%= otherVersion.label %>
                  <%= otherVersion.id == memberpet.birdypetId ? "[current]" : "" %>
                </option>
                <% } %>
              </select>
            <% } %>
            </div>
          </div>

          <div class="mb-3">
            <h5><label>Description</label></h5>
            <textarea name="description" maxlength="500" class="form-control" style="height: 150px; width: 100%;"><%= memberpet.description %></textarea>
          </div>

          <% if (locals.allFlocks) { %>
            <h5 class="mb-4"><label>Flocks</label> <a href="/flocks"><small>(manage)</small></a></h5>
            <% for (var flock of allFlocks) { %>
            <p>
              <label>
                <input type="checkbox" name="flocks[]" class="form-check-input" value="<%= flock._id%>" <%= memberpet.flocks && (memberpet.flocks.includes(flock._id) || memberpet.flocks.includes(`${flock._id}`)) ? "checked" : ""%>>
                &nbsp;
                <%= flock.name %>
              </label>
            </p>
            <% } %>
          <% } %>

          <button class="btn btn-primary mt-3" type="submit">Save Changes</button>

          </form>
        <% } else { %>
          <% if (memberpet.description) { %>
            <% for (var para of memberpet.description.split("\r\n")) { %>
              <p><%= para %></p>
            <% } %>
          <% } %>
        <% } %>
      </div>
      <div class="col-md-4 pt-3 border-md-start text-cener text-md-start">
        <div class="d-block d-md-none">
          <%- include('../partials/spacer.ejs'); %>
        </div>

        <% if (locals.loggedInUser && member._id == locals.loggedInUser.id) { %>
          <div class="text-center">
            <% if (member.birdyBuddy != memberpet._id) { %>
            <p><a href="/birdypet/buddy/<%= memberpet._id %>" class="btn btn-primary">üíñ Make Birdy Buddy</a></p>
            <% } else {  %>
            <%- include('../partials/friendshipMeter.ejs', { friendship : memberpet.friendship || 0 }) %>
            <% } %>
            <p><a href="/birdypet/gift/<%= memberpet._id %>" class="btn btn-primary">üéÅ Gift to Someone</a></p>
            <p><a href="/birdypet/release/<%= memberpet._id %>" class="btn btn-primary">üëã Release Bird</a></p>
          </div>

          <%- include('../partials/spacer.ejs'); %>
        <% } %>

        <h6>Common Name</h6>
        <p><a href="/birdypedia/bird/<%= memberpet.species.speciesCode %>"><%= memberpet.species.commonName %></a></p>

        <h6>Scientific Name</h6>
        <p><%= memberpet.species.scientificName %></p>

        <h6>Family</h6>
        <p><a href="/birdypedia?family=<%= memberpet.species.family.toLowerCase() %>"><%= memberpet.species.family %></a></p>

        <h6>Order</h6>
        <p><%= memberpet.species.order %></p>

        <% if (memberpet.version || memberpet.label) { %>
        <h6>Variant</h6>
        <p><%= memberpet.version + ' ' + memberpet.label %></p>
        <% } %>

        <h6>Hatch Date</h6>
        <p><%= new Date(memberpet.hatchedAt * 1).toLocaleString('en-US', { dateStyle: "long" }) %></p>

        <% if (flocks.length > 0) { %>
        <h6>Flocks</h6>
        <p>
        <% for (var flock of flocks) { %>
          <a href="/flocks/<%= flock._id %>"><%= flock.name %></a><br>
        <% } %>
        </p>
        <% } %>
      </div>
    </div>

    <script type="text/javascript">
    $('select[name="variant"]').change(function() {
        var value = this.options[this.options.selectedIndex].value;
        var birdy = document.getElementById('birdy');

        birdy.src = birdy.src.replace(/\/[^\/]+.jpg/, `\/${value}.jpg`);
    });
    </script>
<%- include('../footer.ejs') %>
