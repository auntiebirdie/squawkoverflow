<%- include('../header.ejs') %>

    <%- include('../partials/page-title.ejs', { title : birdypet.nickname ? birdypet.nickname : birdypet.bird.name }) %>

    <div class="row">
      <div class="col-md-6">
        <div class="mb-4 text-center">
          <img class="birdypet full" src="<%= birdypet.variant.image %>">
        </div>
      </div>
      <div class="col-md-6">
        <h4>Who is the lucky person to receive this bird?</h4>
        <h6>&nbsp;</h6>

<script src="https://cdnjs.cloudflare.com/ajax/libs/typeahead.js/0.11.1/typeahead.bundle.min.js" integrity="sha512-qOBWNAMfkz+vXXgbh0Wz7qYSLZp6c14R0bZeVX2TdQxWpuKr6yHjBIM69fcF8Ve4GUX6B6AKRQJqiiAmwvmUmQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <div class="bs-example">
		<h2>Enter your country name</h2>
        <input type="text" class="typeahead tt-query" autocomplete="off" spellcheck="false">
    </div>

<script>
$(document).ready(function(){
var test = ['abc', 'def', 'ghi', 'jkl'];

    // Initializing the typeahead with remote dataset
    $('.typeahead').typeahead(null, {
      name: 'members',
      source: new Bloodhound({
        datumTokenizer: Bloodhound.tokenizers.whitespace,
        queryTokenizer: Bloodhound.tokenizers.whitespace,
        local: test
      }),
      limit: 10 /* Specify maximum number of suggestions to be displayed */
    });
});  
</script>

<style>
.bs-example {
	font-family: sans-serif;
	position: relative;
	margin: 100px;
}
.typeahead, .tt-query, .tt-hint {
	border: 2px solid #CCCCCC;
	border-radius: 8px;
	font-size: 22px; /* Set input font size */
	height: 30px;
	line-height: 30px;
	outline: medium none;
	padding: 8px 12px;
	width: 396px;
}
.typeahead {
	background-color: #FFFFFF;
}
.typeahead:focus {
	border: 2px solid #0097CF;
}
.tt-query {
	box-shadow: 0 1px 1px rgba(0, 0, 0, 0.075) inset;
}
.tt-hint {
	color: #999999;
}
.tt-menu {
	background-color: #FFFFFF;
	border: 1px solid rgba(0, 0, 0, 0.2);
	border-radius: 8px;
	box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
	margin-top: 12px;
	padding: 8px 0;
	width: 422px;
}
.tt-suggestion {
	font-size: 22px;  /* Set suggestion dropdown font size */
	padding: 3px 20px;
}
.tt-suggestion:hover {
	cursor: pointer;
	background-color: #0097CF;
	color: #FFFFFF;
}
.tt-suggestion p {
	margin: 0;
}
</style>


        <div>
          <select id="memberList" class="form-select">
            <option></option>
          <% for (var member of members) { %>
            <option data-avatar="<%= member.avatar %>" data-username="<%= member.username %>" value="<%= member.id %>">
              <%= member.username %>
            </option>
          <% } %>
          </select>

          <div id="memberDisplay" class="my-5"></div>

          <div class="text-center">
            <button id="actionButton" class="btn btn-secondary" type="button" disabled>Send Gift!</button>
          </div>
        </div>
      </div>
    </div>

  <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/xcash/bootstrap-autocomplete@2.3.7/dist/latest/bootstrap-autocomplete.min.js"></script>
  <script type="text/javascript">
    var actionButton = $('#actionButton');
    var memberDisplay = $('#memberDisplay');

    $('#memberList').on('change', function () {
      var option = this.options[this.options.selectedIndex];
      var memberId = option.value;

      if (memberId) {
        memberDisplay.html(`<h3><img src="${option.getAttribute('data-avatar')}" class="rounded-circle" width="75" data-id="${memberId}" onerror="missingMemberAvatar(this)"> ${option.getAttribute('data-username')}</h3>`);
        actionButton.attr('disabled', false);
      }
      else {
        memberDisplay.html("");
        actionButton.attr('disabled', true);
      }
    });

    actionButton.on('click', function (event) {
      var button = event.target;

      if (!button.disabled) { 
        button.parentNode.parentNode.classList.add('loadingData'); 
        button.disabled = true;

        var member = $('#memberList').val();

        $.ajax({
          url: '/api/gift',
          data: JSON.stringify({
            member: member,
            birdypet: '<%= birdypet.id %>'
          }),
          method: 'POST',
          dataType: "json",
          contentType: 'application/json',
          success: function() {
            window.location.replace('/birdypet/<%= birdypet.id %>');
          }
        });
      }
    });

    <% if (locals.selectedMember) { %>
      $('#memberList').val("<%= selectedMember %>").trigger('change');
    <% } %>
  </script>

<%- include('../footer.ejs') %>
