<%- include('../header.ejs') %>

    <%- include('../partials/page-title.ejs', { breadcrumb : "BirdyPets", title : "Gifting" }) %>

    <div class="row">
      <div class="col-md-6">
        <% if (giftpet.userpet.nickname) { %>
          <h4><%= giftpet.userpet.nickname %></h4>
          <h6><%= giftpet.birdypet.species.commonName %></h6>
        <% } else { %>
          <h4><%= giftpet.birdypet.species.commonName %></h4>
          <h6><%= giftpet.birdypet.version %> <%= giftpet.birdypet.label %></h6>
        <% } %>

        <div class="card mt-4 mb-4">
          <div class="birdypet" style="background-image:url('<%= giftpet.birdypet.image %>');"></div>
        </div>
      </div>
      <div class="col-md-6">
        <h4>Who is the lucky person to receive this gift?</h4>
        <h6>&nbsp;</h6>

        <input class="form-control mt-4" list="memberListOptions" id="memberList" placeholder="Pick a member..." autocomplete="off">
        <datalist id="memberListOptions">
        <% for (var member of members) { %>
          <option data-id="<%= member._id %>" data-avatar="<%= member.avatar %>" value="<%= member.username %>">
          </option>
        <% } %>
        </datalist>

        <div id="memberDisplay" class="mt-3"></div>
      </div>
    </div>

    <div class="row">
      <form id="giftBirdyPet" method="post" class="text-center">
        <input id="giftTo" name="member" type="hidden">
        <button id="actionButton" class="btn btn-primary" type="submit" disabled>Send Gift!</button>
      </form>
    </div>

    <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/xcash/bootstrap-autocomplete@2.3.7/dist/latest/bootstrap-autocomplete.min.js"></script>
    <script type="text/javascript">
      var actionButton = $('#actionButton');
      var memberDisplay = $('#memberDisplay');

      $('#memberList').on('input', function () {
        var option = $('#memberListOptions option[value="' + this.value + '"]')[0];
        var memberId = option.getAttribute('data-id');

        try {
          $('#giftTo').val(memberId);

          memberDisplay.html(`<h3><img src="${option.getAttribute('data-avatar')}" class="member-avatar" data-id="${memberId}" onerror="missingMemberAvatar(this)"> ${option.value}</h3>`);

          actionButton.attr('disabled', false);
        }
        catch (err) {
          $('#giftTo').val("");
          memberDisplay.html("");
          actionButton.attr('disabled', true);
        }
      });

      <% if (locals.selectedMember) { %>
        $('#memberList').val("<%= members.find((member) => member._id == selectedMember).username%>").trigger('input');
      <% } %>
    </script>

<%- include('../footer.ejs') %>
