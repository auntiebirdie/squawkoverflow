<%- include('../header.ejs') %>

  <%- include('../partials/page-title.ejs', {
        title: `Exchange ${exchange.memberA == loggedInUser.id ? 'Request' : 'Offer'}`,
        subtitle: exchange.state != 'Completed!' ? 'You can click on any bird on this screen to remove it from the offer or request.' : 'The offer was accepted by both parties!'
      }) %>

  <div id="errorMessage" class="bg-warning text-dark p-3 w-50 mx-auto rounded mb-3 d-none"></div>

 <% if (exchange.statusA >= 0 && exchange.statusB >= 0) { %>
  <div id="exchange" class="row">
    <%- include('../partials/exchange.ejs', { member : exchange.memberA == loggedInUser.id ? loggedInUser : exchange.member, side : 'A' }) %>

    <%- include('../partials/exchange.ejs', { member : exchange.memberA == loggedInUser.id ? exchange.member : loggedInUser, side : 'B' }) %>
  </div>
 <% } %>

 <% if (exchange.statusA >= 0 && exchange.statusB >= 0 && exchange.statusA + exchange.statusB < 4) { %>
  <div class="text-center py-5">
   <% if (exchange.mutable) { %>
    <script src="https://cdn.socket.io/4.4.1/socket.io.min.js" integrity="sha384-fKnu0iswBIqkjxrhQCTZ7qlLHOFEgNkRmK2vaO/LbTZSXdJfAu6ewRBdwHPhBo/H" crossorigin="anonymous"></script>
    <script type="text/javascript">
      var errorMessage = document.getElementById('errorMessage');

      const socket = io();

      socket.emit('loaded');

      socket.on('update', (data) => {
        var keys = Object.keys(data);

        for (var key of keys) {
          switch (key) {
            case 'birdypet':
              var birdypet = $(`.birdypet[data-id="${data[key]}"]`);

              if (birdypet.length > 0) {
                birdypet[0].parentNode.parentNode.classList[data.disabled ? 'add' : 'remove']('disabled');
              }
              else {
                var container = document.createElement('div');
                container.className = 'col-12 col-lg-6 d-flex align-items-stretch loadingData';

                $(`#birdypets${data.member == '<%= exchange.memberA %>' ? 'A' : 'B'}`).append(container);

                $.ajax({
                 cache: false,
                  url: `/api/birdypet?id=${data.birdypet}&include[]=memberData&member=${data.member == '<%= exchange.memberA %>' ? '<%= exchange.memberB %>' : null}`,
                  method: 'GET',
                  contentType: 'application/json',
                  success: function(data) {
                    console.log(data);
                  }
                });
              }
              break;
            case 'noteA':
            case 'noteB':
              var content = '<p><em>Notes from them:</em></p>';

              for (var para of data[key].split("\r\n")) {
                content += `<p>${para}</p>`;
              }

              $(`#${key}`).html(content);
              break;
          }
        }
      });

      $('#exchange').on('click', '.card', function (e) {
        if (e.target.nodeName != 'A') {
          var image = e.currentTarget.querySelector('.birdypet');
          var container = image.parentNode.parentNode;

          if (!image.style.opacity) {
            image.style.opacity = .5;
            container.classList.add('loadingData');

            $.ajax({
              cache: false,
              url: '/api/exchanges',
              data: JSON.stringify({
                birdypet: image.getAttribute('data-id'),
                exchange: '<%= exchange.id %>'
              }),
              dataType: 'json',
              method: 'POST',
              contentType: 'application/json',
              success: function(data) {
                image.style.opacity = null;
                image.innerHTML = "";

                container.classList.remove('loadingData');
                container.classList.add('disabled');

                $('#makeOffer').text('Update Offer');

                socket.emit('update', { birdypet : image.getAttribute('data-id'), disabled: container.classList.contains('disabled') });
              }
            });
          }
        }
      });

      $('#giveA, #forB, #noteA textarea, #noteB textarea').on('change', function (e) {
        let data = {
          exchange: '<%= exchange.id %>'
        };

        data[this.getAttribute('name') || this.getAttribute('id')] = $(this).val();

        $.ajax({
          cache: false,
          url: '/api/exchanges',
          data: JSON.stringify(data),
          dataType: 'json',
          method: 'POST',
          contentType: 'application/json',
          success: function (res) {
            socket.emit('update', data);
          }
        });
      });

      $('#makeOffer').on('click', function () {
        let button = this;

        if (!button.style.opacity) {
          button.style.opacity = .5;

          let container = button.parentNode.parentNode.parentNode;
          container.classList.add('loadingData');
          errorMessage.classList.add('d-none');

          $.ajax({
            cache: false,
            url: '/api/exchanges',
            data: JSON.stringify({
              id: '<%= exchange.id %>',
              giveA: $('#giveA').val(),
              forB: $('#forB').val(),
             <% if (exchange.memberA == loggedInUser.id) { %>
              noteA: $('#noteA texetarea').val()
             <% } else { %>
              noteB: $('#noteB textarea').val()
             <% } %>
            }),
            dataType: 'json',
            method: 'PUT',
            contentType: 'application/json',
            success: function(data) {
              if (data.error) {
                button.style.opacity = null;
                container.classList.remove('loadingData');
                errorMessage.classList.remove('d-none');
                errorMessage.innerHTML = '⚠️ ' + data.error;
              }
              else {
                window.location.reload();
              }
            }
          });
        }
      });
    </script>
   <% } %>

    <script type="text/javascript">
      $('#deleteOffer').on('click', function () {
        let button = this;

        if (!this.style.opacity) {
          button.style.opacity = .5;

          let container = button.parentNode.parentNode.parentNode;
          container.classList.add('loadingData');

          $.ajax({
            cache: false,
            url: '/api/exchanges',
            data: JSON.stringify({
              id: '<%= exchange.id %>'
            }),
            dataType: 'json',
            method: 'DELETE',
            contentType: 'application/json',
            success: function(data) {
              window.location.reload();
            }
          });
        }
      });
    </script>
  </div>
 <% } %>

  <div class="bg-light p-4 mt-5 rounded w-50 mx-auto">
    <h6 class="mb-3"><em>Recent activity:</em></h6>
    <div class="small">
     <% if (exchange.logs.length > 0) { %>
       <% for (let activity of exchange.logs) { %>
        <p><%= activity.log.replace(`<${loggedInUser.id}>`, loggedInUser.username).replace(`<${exchange.member.id}>`, exchange.member.username) %></p>
       <% } %>
      <% } else { %>
        <p><em>None... yet!</em></p>
      <% } %>
    </div>
  </div>

<%- include('../footer.ejs') %>
