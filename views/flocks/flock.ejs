<%- include('../header.ejs') %>

    <%- include('../partials/page-title.ejs', { title : entity.name, breadcrumb: locals.loggedInUser && loggedInUser.id == member._id ? 'Manage Flock' : `${member.username}'s Flock`  }) %>

    <%- include('../partials/filter-search-sort.ejs', { includeAllFamily: true, selectedFlock: entity._id, sortFields : [{ "value" : "hatched-at", "label" : "Hatched At" }, { "value" : "name", "label" : "Name" }, { "value" : "common-name", "label" : "Species" }] }) %>

    <%- include('../partials/spacer.ejs') %>

    <div class="row filter-container">
      <% for (var userpet of userpets) { %>
      <div class="col-md-3 filter-item" data-category="<%= [userpet.birdypet.species.family.toLowerCase(), ...(userpet.flocks.length > 0 ? userpet.flocks : ["flockless"]), (userpet.nickname ? "nicknamed" : "nonickname")].join(", ") %>">
        <div class="pb-4">
          <div class="card <%= locals.loggedInUser && entity.member == loggedInUser.id && (userpet.flocks.includes(entity._id) || userpet.flocks.includes(`${entity._id}`)) ? "border-primary" : "" %>">
          <% if (userpet.birdypet) { %>
            <p></p>
            <div class="lazy birdypet" data-id="<%= userpet.id %>" data-bg="https://storage.googleapis.com/birdypets/<%= userpet.birdypet.species.order %>/<%= userpet.birdypet.species.family %>/<%= userpet.birdypet.species.scientificName %>/<%= userpet.birdypet.id %>.jpg"></div>
            <h3 class="text-center"><%= userpet.nickname ? userpet.nickname : userpet.birdypet.species.commonName %></h3>
            <h6 class="text-center"><%= userpet.nickname ? userpet.birdypet.species.commonName : (userpet.birdypet.label + " " + userpet.birdypet.version) %></h6>
          <% } %>
          </div>
        </div>
      </div>
      <% } %>
    </div>

  <%- include('../scripts/filterizr.ejs') %>

  <% if (locals.loggedInUser && entity.member == loggedInUser.id) { %>
  <script>
    var loader = `
      <div class="spinner-border d-block mx-auto" role="status">
        <span class="visually-hidden">Saving...</span>
      </div>
    `;

    $('.filter-container').on('click', '.card', function () {
      var image = this.querySelector('.birdypet');

      if (!image.style.opacity) {
        image.style.opacity = .5;
        image.innerHTML = loader;

        $.ajax({
          cache: false,
          url: `/api/flocks/<%= entity._id %>/${image.getAttribute('data-id')}`,
          dataType: "json",
          success: function(data) {
            image.style.opacity = null;
            image.innerHTML = "";

            $(image.parentNode)[`${data.action}Class`]('border-primary');
          }
        });
      }
    });
  </script>
  <% } %>

<%- include('../footer.ejs') %>
