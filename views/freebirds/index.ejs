<%- include('../header.ejs') %>

    <%- include('../partials/page-title.ejs', { title : 'Free Birds' }) %>

    <p>Look out!  There are birds on the loose!!  They've been released and are running around stealing things for their nests.  Do you have space in your aviary for any of them?</p>

    <%- include('../partials/spacer.ejs') %>

    <div class="row">
      <% if (birdypets.length > 0) { %>
        <% for (var birdypet of birdypets) { %>
        <div class="col-md-3">
          <div class="pb-4">
            <div class="card" style="cursor: pointer">
              <div class="lazy birdypet <%= userpets.includes(birdypet.species.speciesCode) ? (userpets.includes(birdypet.id) ? "checkmark2" :"checkmark1") : "" %>"
                   data-id="<%= birdypet.id %>"
                   data-bg="https://storage.googleapis.com/birdypets/<%= birdypet.species.order %>/<%= birdypet.species.family %>/<%= birdypet.species.scientificName %>/<%= birdypet.id %>.jpg"
              ></div>
              <h3 class="text-center"><%= birdypet.species.commonName %></h3>
              <h6 class="text-center"><%= birdypet.label + " " + birdypet.version %></h6>
            </div>
          </div>
        </div>
        <% } %>
      <% } else { %>
        <p><em>There are no recently released birds... maybe it's time to <a href="/hatch">hatch some of your own?</a></em></p>
      <% } %>
    </div>

  <% if (locals.loggedInUser) { %>
  <script>
    var loader = `
      <div class="spinner-border d-block mx-auto" role="status">
        <span class="visually-hidden">Saving...</span>
      </div>
    `;

    $('.row').on('click', '.card', function () {
      var image = this.querySelector('.birdypet');
      var h3 = this.querySelector('h3');
      var h6 = this.querySelector('h6');

      this.style.cursor = 'default';

      if (!image.style.opacity) {
        image.style.opacity = .5;
        image.innerHTML = loader;

        $.ajax({
          cache: false,
          url: `/api/freebirds/${image.getAttribute('data-id')}`,
          dataType: "json",
          success: function(data) {
            image.innerHTML = "";

            if (data.error) {
              h6.innerHTML = data.error;
            }
            else {
              h3.innerHTML = data.response;
            }
          }
        });
      }
    });
  </script>
  <% } %>

<%- include('../footer.ejs') %>
