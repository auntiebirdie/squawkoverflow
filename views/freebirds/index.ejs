<%- include('../header.ejs') %>

    <%- include('../partials/page-title.ejs', { title : 'Free Birds' }) %>

    <p>Look out!  There are birds on the loose!!  They've been released and are running around stealing things for their nests.  Do you have space in your aviary for any of them?</p>

    <div class="row">
      <% if (birdypets.length > 0) { %>
        <% for (var birdypet of birdypets) { %>
        <div class="col-md-3">
          <div class="pb-4">
            <div class="h-100 card" style="cursor: pointer">
              <a class="wishlist-heart">
                <%= birdypet.wishlisted ? '❤️' : '' %>
              </a>
              <div class="bg-white lazy birdypet checkmark<%= birdypet.checkmark %>"
                   data-id="<%= birdypet.ackId %>"
                   data-birdypet="<%= birdypet.id %>"
                   data-bg="<%= birdypet.image %>"
              ></div>
              <h3 class="mt-3 text-center"><%= birdypet.species.commonName %></h3>
              <h6 class="mb-3 text-center"><%= birdypet.label %></h6>
            </div>
          </div>
        </div>
        <% } %>
      <% } else { %>
        <p><em>There are no recently released birds... maybe it's time to <a href="/hatch">hatch some of your own?</a></em></p>
      <% } %>
    </div>

  <% if (locals.loggedInUser) { %>
  <script>
    $('.row').on('click', '.card', function () {
      var image = this.querySelector('.birdypet');
      var h3 = this.querySelector('h3');
      var h6 = this.querySelector('h6');

      this.style.cursor = 'default';

      if (!image.parentNode.classList.contains('loadingData') && image.hasAttribute('data-id')) {
        image.parentNode.classList.add('loadingData');

        $.ajax({
          cache: false,
          url: `/api/collect`,
          data: JSON.stringify({
            birdypet: `${image.getAttribute('data-birdypet')}`,
            freebird: `${image.getAttribute('data-id')}`
          }),
          dataType: 'json',
          contentType: 'application/json',
          method: 'POST',
          success: function(data) {
            image.removeAttribute('data-id');
            image.parentNode.classList.remove('loadingData');

            if (data.error) {
              h6.innerHTML = data.error;
            }
            else {
              h3.innerHTML = `<a href="/birdypet/${data}" target="_blank">${h3.innerText}</a>`;
            }
          }
        });
      }
    });
  </script>
  <% } %>

<%- include('../footer.ejs') %>
