<%- include('../header.ejs') %>

  <div id="eggs">
    <%- include('../partials/page-title.ejs', { title : "Hatch Eggs" }) %>

    <div class="row text-center mb-5">
      <% if (eggs.length > 0) { %>
        <% for (var egg of eggs) { %>
        <div class="col-6 col-md-4 col-lg-2 mb-3">
          <a data-egg="<%= egg.adjective %>" class="mb-2" role="button">
            <h3>
              <img src="https://storage.googleapis.com/squawkoverflow/<%= egg.icon || 'eggs/D/default.png' %>">
            </h3>
            <h4><%= egg.adjective %></h4>
           <% if (loggedInUser.tier.extraInsights) { %>
            <h5 class="text-muted">
              <%= egg.numHatched %>/<%= egg.numSpecies %>
            </h5>
             <% } %>
          </a>
        </div>
        <% } %>
      <% } else if (loggedInUser.settings.general_removeCompleted) { %>
        <p><em>You appear to have collected every species from every egg!  To hatch more eggs anyway, head to <a href="/settings">Settings</a> and uncheck the "remove completed eggs" option.</em></p>
      <% } else { %>
        <p><em>Something went wrong!  Please <a href="https://bugs.squawkoverflow.com/?member=<%= loggedInUser.id %>" target="_blank">submit a bug report</a> so someone can look into it.</em></p>
      <% } %>
    </div>

    <div class="row text-center mt-5">
      <div class="col">
        <p><small><em><a href="/faq#weird-eggs" target="_blank">What's with the weird eggs?</a></em></small></p>
       <% if (loggedInUser.tier.extraInsights) { %>
        <p><small><em><a href="/faq#extra-insights" target="_blank">What do the numbers below the eggs mean?</a></em></small></p>
       <% } %>
      </div>
    </div>
  </div>

  <div id="hatched" class="d-none">
    <%- include('../partials/page-title.ejs', { title : "You hatch the %adjective% egg to discover..." }) %>

    <div class="row">
      <div class="col-md-8 text-center mb-3">
        <img src="" class="birdypet full border border-1 bg-white">
      </div>
      <div class="col-md-4 text-center text-md-start">
        <h3>
          <a href="" target="_blank"></a>
        </h3>
        <h5></h5>
        <h6 class="my-3"></h6>

        <div id="actions" class="mt-5 text-center">
          <a data-action="keep" class="btn btn-lg btn-secondary mb-3" role="button">‚ù§Ô∏è&nbsp;Keep</a>
          &nbsp;
          <a data-action="release" class="btn btn-lg btn-secondary mb-3" role="button">üëã&nbsp;Release</a>
        </div>
      </div>
    </div>
  </div>

  <script>
    var eggs = document.getElementById('eggs');
    var hatched = document.getElementById('hatched');
    var actions = document.getElementById('actions');

    var egg, variant;

    $(eggs).one('click', 'a', function (e) {
      egg = e.currentTarget.getAttribute('data-egg');

      eggs.classList.add('loadingData');

      $.ajax({
        cache: false,
        url: `/api/hatch`,
        data: JSON.stringify({
          egg : egg
        }),
        dataType: "json",
        contentType: 'application/json',
        method: "POST",
        success: function(data) {
          variant = data.id;

          hatched.querySelector('h1').innerHTML = hatched.querySelector('h1').innerHTML.replace('%adjective%', egg);
          hatched.querySelector('img').setAttribute('src', data.image);

          var h3 = hatched.querySelector('h3').querySelector('a');
          h3.setAttribute('href', `/birdypedia/bird/${data.bird.code}`);
          h3.innerHTML = data.bird.commonName;

          var h5 = hatched.querySelector('h5');
          // add label to returned data

          var h6 = hatched.querySelector('h6');
          var text = "";

          if (data.owned > 1) {
            text += `<div><span class="checkplus"></span> <em>You have more than one of this species</em></div>`;
          }
          else if (data.owned == 1) {
            text += `<div><span class="checkmark"></span> <em>You have this species</em></div>`;
          }

          if (data.wishlisted) {
            switch (data.wishlisted) {
              case 2:
                text += `<div>üåü <em>You need this bird!/em></div>`;
                break;
              case 1:
                text += `<div>‚ù§Ô∏è <em>You want this bird!</em></div>`;
            }
          }

          h6.innerHTML = text;

          eggs.classList.remove('loadingData');
          eggs.classList.add('d-none');

          hatched.classList.remove('d-none');
        }
      });
    });

    $(actions).on('click', 'a[data-action]', function (e) {
      var button = e.currentTarget;

      if (!button.style.opacity) { 
        var action = button.getAttribute('data-action');

        actions.classList.add('loadingData');
        actions.innerHTML = "";

        switch (button.getAttribute('data-action')) {
          case "keep":
            $.ajax({
              cache: false,
              url: `/api/collect`,
              data: JSON.stringify({
                variant: variant,
                adjective : egg
              }),
              dataType: "json",
              contentType: 'application/json',
              method: "POST",
              success: function(birdypet) {
                actions.classList.remove('loadingData');
                actions.innerHTML = `<a class="btn btn-lg btn-secondary mb-3" href="/birdypet/${birdypet.id}">üê£ View BirdyPet</a>&nbsp;<a class="btn btn-lg btn-secondary mb-3" href="/hatch">ü•ö Hatch Another Egg</a>`;
              },
              error: function(XMLHttpRequest, textStatus, errorThrown) {
                actions.classList.remove('loadingData');
                actions.innerHTML = '<em>Something went wrong!  Please <a href="https://bugs.squawkoverflow.com/?member=<%= loggedInUser.id %>" target="_blank">submit a bug report</a> so someone can look into it.</em>';
              }
            });
            break;
          case "release":
            $.ajax({
              cache: false,
              url: `/api/release`,
              data: JSON.stringify({
                variant : variant
              }),
              dataType: "json",
              contentType: 'application/json',
              method: "POST",
              success: function(data) {
                window.location.reload();
              }
            });
            break;
        }
      }
    }); 
  </script>

<%- include('../footer.ejs') %>
