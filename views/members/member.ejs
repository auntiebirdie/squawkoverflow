<%- include('../header.ejs') %>

  <%- include ('../partials/page-title.ejs', { title : member.username }) %>

  <div class="row">
    <div class="col-sm-6 col-md-3">
      <img class="member-avatar" src="<%= member.avatar %>" data-id="<%= member._id %>" onerror="missingMemberAvatar(this)">
    </div>
    <div class="col-sm-6 col-md-3">
      <br>
      <h5>Joined</h5>
      <p><%= new Date(member.joinedAt * 1).toLocaleString('en-US', { dateStyle: "long" }) %></p>

      <% if (birdypets > 0) { %>
      <h5>Aviary</h5>
      <p><a href="/aviary/<%= member._id %>"><%= birdypets %> BirdyPets</a></p>
      <% } %>
    </div>
    <div class="col-md-6 text-end">
      <% if (locals.loggedInUser && loggedInUser.id != member._id) { %>
        <p><a href="/members/<%= member._id %>/gift" class="btn btn-primary">ğŸ Send Gift</a></p>
      <% } %>
    </div>
  </div>

  <% if (member.birdybuddy) { %>
  <div class="row">

  </div>
  <% } %>

  <% if (birdybuddy.birdypet) { %>
    <%- include('../partials/spacer.ejs') %>

    <h3 class="mb-4">Birdy Buddy</h3>

    <div class="row">
      <div class="col-md-6 text-center">
        <div class="birdybuddy">
          <img src="<%= birdybuddy.birdypet.image %>">
          <span class="message" style="display: none;"></span>
        </div>
      </div>
      <div class="col-md-6">
        <h4><a href="/birdypet/<%= birdybuddy._id %>"><%= birdybuddy.nickname ? birdybuddy.nickname : birdybuddy.birdypet.species.commonName %></a></h4>
        <div>
          <%- include('../partials/friendshipMeter.ejs', { friendship : birdybuddy.friendship }) %>

          <% if (locals.loggedInUser && bugs > 0) { %>
             <p>&nbsp;</p>
             <p><button id="feedBug" class="btn btn-primary" role="button" data-birdypet="<%= birdybuddy._id %>">ğŸ› Feed a Bug (you have <span><%= bugs %></span>)</button></p>
          <% } %>
        </div>
      </div>
    </div>
  <% } %>

  <% if (flock) { %>
    <%- include('../partials/spacer.ejs'); %>

    <h4 class="mb-5"><%= flock.name %></h4>

    <div class="row">
      <% for (var userpet of flockpets) { %>
      <div class="col-md-3">
        <div class="pb-4">
          <div class="card">
            <% if (userpet.birdypet) { %>
            <p></p>
            <a href="/birdypet/<%= userpet._id %>">
              <div class="lazy birdypet" data-bg="<%= userpet.birdypet.image %>"></div>
            </a>
            <h3 class="text-center"><a href="/birdypet/<%= userpet.id %>"><%= userpet.nickname ? userpet.nickname : userpet.birdypet.species.commonName %></a></h3>
            <h6 class="text-center"><%= userpet.nickname ? userpet.birdypet.species.commonName : (userpet.birdypet.label + " " + userpet.birdypet.version) %></h6>
            <% } %>
          </div>
        </div>
      </div>
      <% } %>
    </div>
  <% } %>

  <script type="text/javascript">
    var message = $('.birdypet .message');

    $('#feedBug').on('click', function (event) {
        var button = this;

        $.ajax({
          cache: false,
          url: `/api/birdypet/${this.getAttribute('data-birdypet')}/feedBug`,
          dataType: "json",
          success: function(data) {
            if (!data.error) {
              message.text(data.response).show();
              button.childNodes[1].innerText = data.bugs;

              if (data.bugs == 0) {
                button.disabled = true;
              }
            }
            else {
              button.innerText = data.error;
              button.disabled = true;
            }
          }
        });
    });
  </script>

<%- include('../footer.ejs') %>
