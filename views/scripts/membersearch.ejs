<script type="text/javascript">
  var memberSearch, memberButton, memberDisplay, _CACHE;
  var selectedMember = <%- locals.selectedMember ? JSON.stringify(selectedMember) : 'null' %>;
  var _TRAPCARD = false;

  $(document).ready(function () {
    memberSearch = $('#memberSearch .typeahead');
    memberButton = $('#memberButton');
    memberDisplay = $('#memberDisplay');

    setupMemberSearch();

    try {
      let giftingPrefs = JSON.parse(localStorage.getItem('giftingPrefs')) || { wants : true, needs : true };

      document.getElementById('member-wants').setAttribute('checked', giftingPrefs.wants);
      document.getElementById('member-needs').setAttribute('checked', giftingPrefs.needs);
    } catch (err) { }

    $('#memberSearch').on('change', 'input[type="checkbox"]', function () {
      try {
        let wants = document.getElementById('member-wants').checked;
        let needs = document.getElementById('member-needs').checked;

        localStorage.setItem('giftingPrefs', JSON.stringify({ wants, needs }));
      } catch (err) { }

      let query = memberSearch.typeahead('val');

      _TRAPCARD = true;

      memberSearch.typeahead('val', '.').typeahead('val', query);
    });
  });

  function setupMemberSearch () {
    memberSearch.typeahead({
      hint: false,
      highlight: true,
      minLength: 0
    },
    {
      name: 'members',
      displayKey: 'username',
      async: true,
      source: function (query, syncResults, asyncResults) {
        return new Promise((resolve, reject) => {
          if (_TRAPCARD) {
            _TRAPCARD = false;
            return resolve([]);
          }

          let data = {
            bird: $('#memberSearch').attr('data-bird') || "",
            <%- locals.include ? `include: ${JSON.stringify(include)},` : "" %>
            <%- locals.privacy ? `privacy: ${JSON.stringify(privacy)},` : "" %>
          };

          if (_CACHE) {
            resolve(_CACHE);
          } else {
            API.call('members', 'GET', data, function (results) {
              _CACHE = results;

              resolve(results);
            });
          }
        }).then((results) => {
          try {
            let wants = document.getElementById('member-wants').checked;
            let needs = document.getElementById('member-needs').checked;

            if (wants && needs) {
              results = results.filter((result) => result.wishlisted > 0);
            }
            else if (wants || needs) {
              results = results.filter((result) => result.wishlisted == (wants ? 1 : 2));
            }
          } catch (err) { }

          var matches, substringRegex;

          matches = [];

          substrRegex = new RegExp(query, 'i');

          $.each(results, function(i, result) {
            if (substrRegex.test(result.username)) {
              matches.push(result);
            }
          });

          asyncResults(matches.sort((a, b) => {
            if (a.wishlisted || a.owned) {
              if (a.wishlisted != b.wishlisted) {
                return b.wishlisted - a.wishlisted;
              } else {
                return a.owned - b.owned;
              }
            } else {
              return a.username.localeCompare(b.username);
            }
          }));
        });
      },
      limit: Infinity,
      templates: {
        empty: function () {
          return '<div class="px-1 py-2"><em>No members found.</em></div>';
        },
        pending: function () {
          return '<div class="mx-1 fst-italic"><div class="spinner-border spinner-border-sm" role="status"></div> Searching...</div>';
        },
        suggestion: function (data) {
          var text = '<div class="px-1 py-2">';

          text += `<img src="${data.avatar}" class="rounded" width="42" onerror="missingMemberAvatar(this)"> ${data.username}`;

          if (data.owned > 1) {
            text += `<div class="small ms-5"><span class="checkplus"></span> <em>Multiple in aviary</em></div>`;
          }
          else if (data.owned == 1) {
            text += `<div class="small ms-5"><span class="checkmark"></span> <em>In aviary</em></div>`;
          }

          if (data.wishlisted) {
            switch (data.wishlisted) {
              case 2:
                text += `<div class="small ms-5">üåü <em>Needs it</em></div>`;
                break;
              case 1:
                text += `<div class="small ms-5">‚ù§Ô∏è  <em>Wants it</em></div>`;
                break;
            }
          }

          let lastActive = Date.now() - new Date(data.lastActivityAt).getTime();

          let days = lastActive / (1000 * 60 * 60 * 24);

          if (days <= 1) {
            data.lastActive = 'Today!';
          } else if (days <= 7) {
            data.lastActive = 'This week';
          } else {
            let weeks = days / 7;

            if (weeks <= 4) {
              data.lastActive = Math.ceil(weeks) + ' weeks ago';
            } else {
              let months = days / 30;

              if (months <= 6) {
                data.lastActive = Math.ceil(months) + ' months ago';
              } else {
                data.lastActive = '6+ months ago';
              }
            }
          }

          text += '<div class="small ms-5">Last Active: ' + data.lastActive + '</div>';

          text += '</div>';

          return text;
        }
      }
    }).on('typeahead:selected', function (obj, member) {
      selectedMember = member;

      updateMemberDisplay();
    }).on('typeahead:autocomplete', function (obj, member) {
      selectedMember = member;

      updateMemberDisplay();
    }).on('typeahead:change', function (obj, member) {
      if (selectedMember.username != member) {
        selectedMember = null;

        updateMemberDisplay();
      }
    });

    function updateMemberDisplay() {
      if (selectedMember) {
        memberDisplay.html(`<img src="${selectedMember.avatar}" class="rounded" width="45" data-id="${selectedMember.id}" onerror="missingMemberAvatar(this)">`);
        memberButton.attr('disabled', false);
      }
      else {
        memberDisplay.html("");
        memberButton.attr('disabled', true);
      }
    }
  }
</script>
